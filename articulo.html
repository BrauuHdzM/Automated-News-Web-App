<!DOCTYPE html>
<html data-bs-theme="light" lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Artículo generado</title>
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/FontAwesome.css">
    <link rel="stylesheet" href="/css/Toggle-Switch-toggle-switch.css">
    <link rel="stylesheet" href="/css/Toggle-Switch.css">
    <link rel="stylesheet" href="/css/User-Rating-F19690.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">


    <style>
        .star-rating li {
            display: inline;
            cursor: pointer;
            color: gray; 
            font-size: 24px; 
        }
        .star-rating li.checked {
            color: gold; 
        }
    </style>
    
    
</head>

<body>
    <nav class="navbar navbar-expand-md fixed-top navbar-shrink py-3 navbar-light bg-primary" id="mainNav">
        <div class="container">
            <a class="navbar-brand" style="color: white;" href="/articulos"><span>Generación de noticias</span></a>
            <div class="collapse navbar-collapse" id="navcol-1">
                <ul class="navbar-nav mx-auto">
                </ul>
                <a class="btn btn-warning shadow d-none d-md-block" role="button" href="/articulos">Regresar</a>
            </div>
            <a class="btn btn-warning shadow d-md-none" role="button" href="/articulos">
                <i class="bi bi-arrow-left"></i> 
            </a>
        </div>
    </nav>
    
    

    <section class="py-5 mt-5">
        <div class="container py-5">
            <div class="row mb-5">
                <div id="titulo" class="col-md-8 col-xl-6 text-center mx-auto fw-bold">
                    <h2 class="fw-bold">Título del artículo</h2>
                </div>
            </div>
            <div class="row mb-5">   
                <div id= "fecha" class="col-md-8 col-xl-6 text-center mx-auto">
                <p>Fecha</p>
            </div>
            <div class="row mb-5">   
                <div id= "modelo" class="col-md-8 col-xl-6 text-center mx-auto">
                <p>Creado con: </p>
            </div>
            </div>
            <div class="col mb-1">
                <div class="d-flex align-items-center align-items-sm-start"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-quote fs-1 text-warning flex-shrink-0">
                        <path d="M12 12a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1h-1.388c0-.351.021-.703.062-1.054.062-.372.166-.703.31-.992.145-.29.331-.517.559-.683.227-.186.516-.279.868-.279V3c-.579 0-1.085.124-1.52.372a3.322 3.322 0 0 0-1.085.992 4.92 4.92 0 0 0-.62 1.458A7.712 7.712 0 0 0 9 7.558V11a1 1 0 0 0 1 1h2Zm-6 0a1 1 0 0 0 1-1V8.558a1 1 0 0 0-1-1H4.612c0-.351.021-.703.062-1.054.062-.372.166-.703.31-.992.145-.29.331-.517.559-.683.227-.186.516-.279.868-.279V3c-.579 0-1.085.124-1.52.372a3.322 3.322 0 0 0-1.085.992 4.92 4.92 0 0 0-.62 1.458A7.712 7.712 0 0 0 3 7.558V11a1 1 0 0 0 1 1h2Z"></path>
                </svg>
                    <div id="articulo" class="text-center">
                        <p class="fs-6 mb-3 ms-2"><span style="color: rgb(0, 0, 0);"></p>
                        <div class="d-flex ms-2">
                            <div class="d-flex mb-3">
                                <p class="fw-bold me-2"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row justify-content-center">
                <div class="col col-md-3 col-xl-6 text-center">
                    <button id="calificarArticulo" class="btn btn-secondary text-center d-block w-100" style="position: relative; display: block; overflow: clip;">Calificar artículo</a>
                </div>
            </div>
            <div class="row justify-content-center mt-3">
                <div class="col col-md-3 col-xl-6 text-center">
                    <button id="eliminarArticulo" class="btn btn-danger text-center">Eliminar artículo</button>
                </div>
            </div>
        </div>        
    </section>
    <footer>
    <div class="container py-4 py-lg-5">
        <hr>
        <div class="text-muted d-flex justify-content-between align-items-center pt-3">
            <p class="mb-0">2024 Generación de noticias</p>
        </div>
    </div>
    </footer>

    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/js/startup-modern.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
          const articulo = JSON.parse(localStorage.getItem('articuloActual'));
          if (articulo) {
            document.getElementById('titulo').textContent = articulo.titulo;
            document.getElementById('fecha').textContent = articulo.fecha;
            document.getElementById('articulo').textContent = articulo.contenido;
            document.getElementById('modelo').textContent = "Creado con: " + articulo.modeloLenguaje;
            localStorage.setItem('idArticuloActual', articulo.idArticulo);
            
            localStorage.removeItem('articuloActual');
          } else {
            console.error('No se encontró el artículo');
          }
        });
        </script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const btnEliminar = document.getElementById('eliminarArticulo');
        btnEliminar.addEventListener('click', function() {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esta acción!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const idArticulo = localStorage.getItem('idArticuloActual');
                    fetch(`/eliminarArticulo/${idArticulo}`, {
                        method: 'DELETE' 
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Falló la eliminación del artículo');
                        }
                        return response.json();
                    })
                    .then(() => {
                        Swal.fire({
                            title: '¡Eliminado!',
                            text: 'El artículo ha sido eliminado.',
                            icon: 'success',
                            confirmButtonText: 'Entendido',
                        }).then((result) => {
                            if (result.isConfirmed){
                                window.location.href = '/articulos';
                            }
                            else {
                                window.location.href = '/articulos';
                            }
                    });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire(
                            'Error',
                            'No se pudo eliminar el artículo.',
                            'error'
                        );
                    });
                }
            });
        });
    });
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const btnCalificar = document.getElementById('calificarArticulo');
            btnCalificar.addEventListener('click', function() {
                const idArticulo = localStorage.getItem('idArticuloActual');
                fetch(`/calificaciones/${idArticulo}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length) {
                        const calificaciones = data[0];
                        const ratingHTML = generateRatingHTML(calificaciones);
                        Swal.fire({
                            title: 'Califica los aspectos del artículo',
                            html: ratingHTML,
                            focusConfirm: false,
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Enviar calificaciones',
                            cancelButtonText: 'Cancelar',
                            didOpen: () => {
                                document.querySelectorAll('.swal2-html-container .star-rating li').forEach(star => {
                                    star.addEventListener('click', function() {
                                        let allStars = this.parentNode.querySelectorAll('li');
                                        let index = Array.from(allStars).indexOf(this);
                                        allStars.forEach((s, idx) => {
                                            if (idx <= index) {
                                                s.classList.add('checked');
                                            } else {
                                                s.classList.remove('checked');
                                            }
                                        });
                                    });
                                });
                            },
                            preConfirm: () => {
                                const ratings = {};
                                let isValid = true;
                                document.querySelectorAll('.swal2-html-container .star-rating').forEach((ul) => {
                                    const aspect = ul.dataset.aspecto;
                                    const checkedStars = ul.querySelectorAll('.checked').length;
                                    ratings[aspect] = checkedStars;
                                    if (checkedStars === 0) {
                                        isValid = false;
                                    }
                                });
                                if (!isValid) {
                                    Swal.showValidationMessage('Todos los aspectos deben tener al menos 1 estrella.');
                                    return false;
                                }
                                return fetch(`/calificaciones/${idArticulo}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(ratings)
                                }).then(response => {
                                    if (!response.ok) {
                                        throw new Error('Failed to update ratings');
                                    }
                                    return response.json();
                                });
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                console.log('Calificaciones actualizadas:', result.value);
                                Swal.fire('Guardado', 'Las calificaciones han sido actualizadas.', 'success');
                            }
                        });
                    }
                });
            });
    
            function generateRatingHTML(calificaciones) {
                let html = '';
                const aspects = [
                    { label: 'Título', key: 'calificacionTitulo' },
                    { label: 'Contenido', key: 'calificacionContenido' },
                    { label: 'Redacción', key: 'calificacionRedaccion' }
                ];
    
                aspects.forEach(aspect => {
                    const rating = calificaciones[0][aspect.key];
                    console.log(`${aspect.label} rating: ${rating}`); 
                    html += `<div><label>${aspect.label}:</label><ul class="star-rating" data-aspecto="${aspect.key}" style="padding: 0;">`;
                    for (let i = 1; i <= 5; i++) {
                        html += `<li style="display: inline; cursor: pointer;" class="${i <= rating ? 'checked' : ''}">★</li>`;
                    }
                    html += '</ul></div>';
                });
                return html;
            }
        });
    </script>
    
        
</body>

</html>